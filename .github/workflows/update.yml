name: Update Blocklist

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *"

env:
  SOURCES: config/sources.txt
  RAW_DIR: lists/_raw
  OUTPUT: lists/merged.txt

permissions:
  contents: write
  actions: write  # Required for cache management

concurrency:
  group: blocklist-update
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install Dependencies
        run: pip install -q .

      # Restore latest available cache (prefix match)
      # The key will never match exactly, so restore-keys finds the most recent
      - name: Restore Cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: .cache
          key: blocklists-${{ github.run_id }}
          restore-keys: blocklists-

      - name: Fetch Sources
        id: fetch
        run: |
          START=$(date +%s)
          python -m scripts.downloader \
            --sources "$SOURCES" \
            --outdir "$RAW_DIR" \
            --cache .cache \
            --concurrency 10 \
            --timeout 25
          echo "time=$(($(date +%s) - START))s" >> $GITHUB_OUTPUT
          echo "count=$(find "$RAW_DIR" -name '*.txt' | wc -l)" >> $GITHUB_OUTPUT

      - name: Compile Sources
        id: compile
        run: |
          START=$(date +%s)
          python -m scripts.pipeline "$RAW_DIR" "$OUTPUT"
          echo "time=$(($(date +%s) - START))s" >> $GITHUB_OUTPUT

      - name: Calculate Stats
        id: stats
        run: |
          RULES=$(wc -l < "$OUTPUT")
          SIZE=$(du -h "$OUTPUT" | cut -f1)
          echo "rules=$RULES" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT

      - name: Validate Output
        run: |
          RULES=${{ steps.stats.outputs.rules }}
          MIN=1000000
          if [ "$RULES" -lt "$MIN" ]; then
            echo "::error::Only $RULES rules (expected >$MIN)"
            exit 1
          fi
          echo "Validation passed: $RULES rules"

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Merged Blocklist
          body: |
            ## Merged Blocklist
            
            | Stat | Value |
            |------|-------|
            | Rules | ${{ steps.stats.outputs.rules }} |
            | Size | ${{ steps.stats.outputs.size }} |
            | Sources | ${{ steps.fetch.outputs.count }} |
            
            ### Usage
            Add to AdGuard Home → Filters → DNS Blocklists:
            ```
            https://github.com/${{ github.repository }}/releases/download/latest/merged.txt
            ```
          files: |
            ${{ env.OUTPUT }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Save cache after successful fetch (even if compile/publish fails)
      # This ensures we don't lose downloaded lists on downstream failures
      - name: Save Cache
        uses: actions/cache/save@v4
        if: always() && steps.fetch.outcome == 'success'
        with:
          path: .cache
          key: blocklists-${{ github.run_id }}

      # Remove old caches to stay within storage limits (keep last 3)
      - name: Cleanup Old Caches
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh cache list --repo ${{ github.repository }} \
            --key blocklists- \
            --sort created_at \
            --order desc \
            --limit 100 \
            --json key \
            --jq '.[3:] | .[].key' | while read -r key; do
              gh cache delete "$key" --repo ${{ github.repository }} --confirm || true
          done

      - name: Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## Build Summary
          
          | Metric | Value |
          |--------|-------|
          | Rules | ${{ steps.stats.outputs.rules || 'N/A' }} |
          | Size | ${{ steps.stats.outputs.size || 'N/A' }} |
          | Sources | ${{ steps.fetch.outputs.count || 'N/A' }} |
          | Fetch Time | ${{ steps.fetch.outputs.time || '?' }} |
          | Compile Time | ${{ steps.compile.outputs.time || '?' }} |
          | Cache | ${{ steps.cache-restore.outputs.cache-matched-key || 'None' }} |
          EOF
