name: Update Blocklist

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *"

env:
  SOURCES: config/sources.txt
  RAW_DIR: lists/_raw
  OUTPUT: lists/merged.txt
  WHITELIST: lists/whitelist.txt

permissions:
  contents: write

concurrency:
  group: blocklist-update
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # â”€â”€ Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: ðŸ“¦ Install Dependencies
        run: pip install -q .

      # â”€â”€ Cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ’¾ Restore Blocklist Cache
        uses: actions/cache@v4
        with:
          path: .cache
          key: sources-${{ hashFiles('config/sources.txt') }}-${{ github.run_number }}
          restore-keys: |
            sources-${{ hashFiles('config/sources.txt') }}-
            sources-

      # â”€â”€ Process â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸŒ Fetch Sources
        id: fetch
        run: |
          START=$(date +%s)
          python -m scripts.fetch_sources \
            --sources "$SOURCES" \
            --outdir "$RAW_DIR" \
            --cache .cache \
            --concurrency 10 \
            --timeout 25
          echo "time=$(($(date +%s) - START))s" >> $GITHUB_OUTPUT
          echo "count=$(find "$RAW_DIR" -name '*.txt' | wc -l)" >> $GITHUB_OUTPUT

      - name: âš™ï¸ Compile & Deduplicate
        id: compile
        run: |
          START=$(date +%s)
          python -m scripts.pipeline "$RAW_DIR" "$OUTPUT" "$WHITELIST"
          echo "time=$(($(date +%s) - START))s" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Calculate Stats
        id: stats
        run: |
          RULES=$(wc -l < "$OUTPUT")
          SIZE=$(du -h "$OUTPUT" | cut -f1)
          echo "rules=$RULES" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT

      # â”€â”€ Validate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âœ… Validate Output
        run: |
          RULES=${{ steps.stats.outputs.rules }}
          MIN=1000000
          if [ "$RULES" -lt "$MIN" ]; then
            echo "::error::âŒ Only $RULES rules (expected >$MIN)"
            exit 1
          fi
          echo "âœ… Validation passed: $RULES rules"

      # â”€â”€ Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸš€ Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Merged Blocklist
          body: |
            ## ðŸ“‹ Merged Blocklist
            
            | ðŸ“ˆ Stat | Value |
            |---------|-------|
            | Rules | **${{ steps.stats.outputs.rules }}** |
            | Size | ${{ steps.stats.outputs.size }} |
            | Sources | ${{ steps.fetch.outputs.count }} |
            
            ### ðŸ“¥ Usage
            Add to AdGuard Home â†’ Filters â†’ DNS Blocklists:
            ```
            https://github.com/${{ github.repository }}/releases/download/latest/merged.txt
            ```
          files: |
            ${{ env.OUTPUT }}
            ${{ env.WHITELIST }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ Cleanup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ§¹ Cleanup Old Cache
        if: always()
        run: find .cache -mtime +7 -delete 2>/dev/null || true

      # â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“ Job Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“Š Build Summary
          
          | ðŸ“ˆ Metric | Value |
          |-----------|-------|
          | ðŸ“ Rules | **${{ steps.stats.outputs.rules || 'N/A' }}** |
          | ðŸ“¦ Size | ${{ steps.stats.outputs.size || 'N/A' }} |
          | ðŸŒ Sources | ${{ steps.fetch.outputs.count || 'N/A' }} |
          | â±ï¸ Fetch | ${{ steps.fetch.outputs.time || '?' }} |
          | â±ï¸ Compile | ${{ steps.compile.outputs.time || '?' }} |
          EOF
