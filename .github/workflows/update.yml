name: Merge Blocklists

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *"

env:
  RAW_OUT: lists/_raw
  MERGED_OUT: lists/merged.txt
  WHITELIST_OUT: lists/whitelist.txt
  SOURCES: config/sources.txt

permissions:
  contents: write

concurrency:
  group: merge-blocklists
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            scripts
            config
            pyproject.toml

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv and dependencies
        run: |
          pip install -q uv
          uv pip install --system -q .

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: .cache
          key: blocklists-${{ github.run_id }}
          restore-keys: blocklists-

      - name: Fetch sources
        id: fetch
        run: |
          start=$(date +%s)
          python -m scripts.fetch_sources \
            --sources "$SOURCES" \
            --outdir "$RAW_OUT" \
            --cache .cache \
            --concurrency 10 \
            --timeout 25
          echo "seconds=$(($(date +%s) - start))" >> $GITHUB_OUTPUT
          echo "files=$(find "$RAW_OUT" -name "*.txt" | wc -l)" >> $GITHUB_OUTPUT

      - name: Compile
        id: compile
        run: |
          start=$(date +%s)
          python -m scripts.pipeline "$RAW_OUT" "$MERGED_OUT" "$WHITELIST_OUT"
          echo "seconds=$(($(date +%s) - start))" >> $GITHUB_OUTPUT

      - name: Stats
        id: stats
        run: |
          echo "rules=$(wc -l < "$MERGED_OUT")" >> $GITHUB_OUTPUT
          echo "size=$(du -h "$MERGED_OUT" | cut -f1)" >> $GITHUB_OUTPUT
          echo "whitelist=$(wc -l < "$WHITELIST_OUT" 2>/dev/null || echo 0)" >> $GITHUB_OUTPUT

      - name: Validate
        run: |
          RULES=${{ steps.stats.outputs.rules }}
          [ "$RULES" -ge 100000 ] || { echo "::error::Too few rules: $RULES"; exit 1; }

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Merged Blocklist
          body: |
            ## Merged Blocklist
            
            | Stat | Value |
            |------|-------|
            | Rules | ${{ steps.stats.outputs.rules }} |
            | Size | ${{ steps.stats.outputs.size }} |
            | Sources | ${{ steps.fetch.outputs.files }} |
            
            **Usage**: Add this URL to AdGuard Home:
            ```
            https://github.com/${{ github.repository }}/releases/download/latest/merged.txt
            ```
          files: |
            ${{ env.MERGED_OUT }}
            ${{ env.WHITELIST_OUT }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: find .cache -mtime +3 -delete 2>/dev/null || true

      - name: Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          | Metric | Value |
          |--------|-------|
          | Rules | ${{ steps.stats.outputs.rules || 'N/A' }} |
          | Fetch | ${{ steps.fetch.outputs.seconds || '?' }}s |
          | Compile | ${{ steps.compile.outputs.seconds || '?' }}s |
          EOF
